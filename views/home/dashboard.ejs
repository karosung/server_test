<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <header class="top-bar">
    <a class="top-bar__home" href="<%= homeUrl %>">Home</a>
  </header>
  <main class="app-shell">
    <section class="card section-card">
      <header class="page-header">
        <h1>Welcome, <%= user.fullName %> (<%= user.username %>)</h1>
        <p class="muted">Keep your details polished and ready anywhere, anytime.</p>
      </header>

      <% if (flash) { %>
        <p class="message <%= flash.type === 'error' ? 'error' : 'success' %>"><%= flash.message %></p>
      <% } %>
    </section>

    <section class="card section-card">
      <h2>Profile Photos</h2>
      <% 
        const totalSlots = typeof maxPhotos === "number" ? maxPhotos : 10;
        const photoList = (photos && Array.isArray(photos)) ? photos : [];
        const secondaryPhotos = photoList.slice(1);
        const maxSecondary = Math.max(totalSlots - 1, 0);
        const remainingSecondarySlots = Math.max(maxSecondary - secondaryPhotos.length, 0);
        const canAddPhoto = photoList.length < totalSlots;
        const blankTiles = Math.max(remainingSecondarySlots - (canAddPhoto ? 1 : 0), 0);
      %>

      <div class="photo-gallery">
        <div class="photo-main" data-photo-index="0">
          <% if (photoList.length > 0) { %>
            <div class="photo-actions">
              <form class="delete-form" data-role="delete-photo-form" action="/dashboard/photo/delete" method="post">
                <input type="hidden" name="index" value="0">
                <button type="submit" class="delete-button" aria-label="Delete primary photo">&minus;</button>
              </form>
            </div>
            <img src="<%= photoList[0] %>" alt="Primary profile photo">
          <% } else { %>
            <div class="photo-placeholder">
              <span>No photos yet</span>
              <small>Add up to <%= totalSlots %> square images (640x640).</small>
            </div>
          <% } %>
        </div>
        <div class="photo-tiles">
          <% secondaryPhotos.forEach(function(photoUrl, index) { %>
            <div class="photo-tile" data-photo-index="<%= index + 1 %>">
              <div class="photo-actions">
                <form class="delete-form" data-role="delete-photo-form" action="/dashboard/photo/delete" method="post">
                  <input type="hidden" name="index" value="<%= index + 1 %>">
                  <button type="submit" class="delete-button" aria-label="Delete photo <%= index + 2 %>">&minus;</button>
                </form>
              </div>
              <img src="<%= photoUrl %>" alt="Profile photo <%= index + 2 %>">
            </div>
          <% }) %>

          <% if (canAddPhoto) { %>
            <button type="button" class="photo-tile add-tile" data-role="add-photo" aria-label="Add another profile photo">
              <span>+</span>
            </button>
          <% } %>

          <% for (let i = 0; i < blankTiles; i++) { %>
            <div class="photo-tile photo-tile--empty"></div>
          <% } %>
        </div>
      </div>
      <div class="photo-gallery-footer">
        <button type="button" class="icon-button" data-role="toggle-delete" aria-pressed="false">
          <span class="icon">&#128465;</span>
          <span>Photo delete</span>
        </button>
      </div>

      <form id="photoUploadForm" action="/dashboard/photo" method="post" enctype="multipart/form-data">
        <input id="photoUploadInput" type="file" name="photo" accept="image/*" hidden>
      </form>
    </section>

    <section class="card section-card">
      <h2>User Information</h2>
      <ul class="data-list">
        <li><strong>Email</strong><span><%= user.email %></span></li>
        <li><strong>Phone</strong><span><%= user.phoneNumber || "-" %></span></li>
        <li><strong>Role</strong><span><%= user.role %></span></li>
        <li><strong>Active</strong><span><%= user.isActive ? "Yes" : "No" %></span></li>
        <li><strong>Created</strong><span><%= user.createdAt ? user.createdAt.toISOString().slice(0, 10) : "-" %></span></li>
        <li><strong>Updated</strong><span><%= user.updatedAt ? user.updatedAt.toISOString().slice(0, 10) : "-" %></span></li>
      </ul>
    </section>

    <section class="card">
      <div class="actions">
        <a class="btn link-button" href="/profile/edit">Edit profile</a>
        <a class="btn link-button" href="/users/search">Search users</a>
        <a class="btn link-button" href="/friends">My friends</a>
        <form action="/logout" method="post">
          <button type="submit" class="btn link-button">Logout</button>
        </form>
        <% if (user.role === "admin") { %>
          <a class="btn link-button" href="/admin">View all users</a>
        <% } %>
      </div>
    </section>
  </main>

  <script>
    (function () {
      var addTile = document.querySelector("[data-role=\"add-photo\"]");
      var toggleDeleteButton = document.querySelector("[data-role=\"toggle-delete\"]");
      var deleteForms = document.querySelectorAll("[data-role=\"delete-photo-form\"]");
      var gallery = document.querySelector(".photo-gallery");
      var fileInput = document.getElementById("photoUploadInput");
      var form = document.getElementById("photoUploadForm");
      var deleteMode = false;

      if (addTile && fileInput && form) {
        addTile.addEventListener("click", function () {
          fileInput.click();
        });

        fileInput.addEventListener("change", function (event) {
          if (event.target.files && event.target.files.length > 0) {
            form.submit();
          }
        });
      }

      if (toggleDeleteButton && gallery) {
        toggleDeleteButton.addEventListener("click", function () {
          deleteMode = !deleteMode;
          toggleDeleteButton.setAttribute("aria-pressed", String(deleteMode));
          if (deleteMode) {
            gallery.classList.add("delete-mode");
            toggleDeleteButton.classList.add("active");
          } else {
            gallery.classList.remove("delete-mode");
            toggleDeleteButton.classList.remove("active");
          }
        });
      }

      deleteForms.forEach(function (deleteForm) {
        deleteForm.addEventListener("submit", function (event) {
          if (!confirm("Delete this photo?")) {
            event.preventDefault();
          }
        });
      });
    })();
  </script>
</body>
</html>
